<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1cm;
      color: #333;
    }
    h1 {
      text-align: center;
      text-transform: uppercase;
      font-size: 1.4em;
      margin-bottom: 0.5em;
    }
    .section-title {
      font-weight: bold;
      text-transform: uppercase;
      border-bottom: 2px solid #555;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-size: 1em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5em;
    }
    th, td {
      border-top: 2px solid #555;
      border-bottom: 2px solid #555;
      padding: 0;
      border-left: none;
      border-right: none;
    }

    .info-table td,
    .info-table th {
      padding: 6px 8px; /* adjust as needed */
      border-top: 2px solid #555;
      border-bottom: 2px solid #555;
      border-left: none;
      border-right: none;
    }

    .info-table td.label {
      background-color: #eee;
      font-weight: bold;
    }

    tr:first-child td,
    tr:first-child th {
      border-top: 2px solid #555;
    }

    tr:last-child td,
    tr:last-child th {
      border-bottom: 2px solid #555;
    }

    td:first-child,
    th:first-child {
      border-left: 2px solid #555;
    }

    td:last-child,
    th:last-child {
      border-right: 2px solid #555;
    }

    td.label {
      background-color: #d8d8d8;
      font-weight: bold;
      width: 20%;
    }
    .notes {
      margin-top: 1.5em;
      border: 2px solid #555;
      padding: 1em;
      height: 250px;
    }
    .footer {
      margin-top: 2em;
      font-size: 0.85em;
      color: #555;
      text-align: center;
      border-top: 1px solid #ccc;
      padding-top: 0.5em;
    }
    .image-table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      margin-top: 1em;
    }
    .image-table td {
      border: none;
      text-align: center;
      vertical-align: top;
    }
    .image-table img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
      object-fit: contain;
    }
    .image-label {
      margin-bottom: 0.3em;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>CHOROIDAL NEVUS ANALYSIS REPORT</h1>

  <div class="section-title">Patient Details</div>
  <table class="info-table">
    <tr>
      <td class="label">Patient ID (MRN)</td>
      <td>{{ patient_id }}</td>
      <td class="label">Age</td>
      <td>{{ age }}</td>
      <td class="label">Sex</td>
      <td>{{ sex }}</td>
    </tr>
    <tr>
      <td class="label">Date of Scan</td>
      <td>{{ exam_date }}</td>
      <td class="label">Eye</td>
      <td>{{ eye }}</td>
      <td class="label">Technician</td>
      <td>Auto</td>
    </tr>
  </table>

<div class="section-title">SEGMENTATION RESULTS</div>
<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
  <tr>
    <th style="text-align: center; padding: 0;">Original Image</th>
    <th style="text-align: center; padding: 0;">Processed Image</th>
  </tr>
  <tr>
    <td style="padding: 5; height: 400px;">
      <img src="data:image/png;base64,{{ orig_base64 }}"
           style="width: 100%; height: 100%; object-fit: contain; display: block;">
    </td>
    <td style="padding: 5; height: 400px;">
      <img src="data:image/png;base64,{{ proc_base64 }}"
           style="width: 100%; height: 100%; object-fit: contain; display: block;">
    </td>
  </tr>
</table>

<div style="margin-top: 15px; padding: 10px; border: 1px solid #ccc;">
  <p style="margin: 0; font-weight: bold; font-size: 14px; color: {{ 'green' if not lesion_detected else 'gray' }}">
    {{ 'No lesion detected.' if not lesion_detected else 'Potential lesion detected.' }}
  </p>

  {% if avg_confidence is defined %}
  <p style="margin: 4px 0 0 0; font-size: 13px;">
    <strong>Model Confidence:</strong> {{ '{:.2%}'.format(avg_confidence) }}
  </p>
  {% endif %}

  <p style="margin: 10px 0 0 0; font-size: 12px; font-style: italic;">
    <strong>Legend:</strong> Yellow contour = predicted lesion boundary
  </p>
</div>

  <div class="section-title">Clinician Notes</div>
  <div class="notes">
    {{ clinician_notes.replace('\n', '<br>') if clinician_notes else '' }}
  </div>

  <div class="section-title">Model Details</div>
  <table class="info-table">
    <tr>
      <td class="label">Model Used</td>
      <td>{{ model_name }}</td>
    </tr>
    <tr>
      <td class="label">Processing Time</td>
      <td>{{ processing_time }}</td>
    </tr>
  </table>

  <div class="footer">
    &copy; {{ year }} NeviSight Project
  </div>

</body>
</html>
